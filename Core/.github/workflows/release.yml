name: System Tools Release

# Trigger only on release creation (tag push)
# This workflow builds and releases the binary system tools
on:
  release:
    types: [ created ]

jobs:
  build-system-tools:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, x86_64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build ccache
        
    - name: Setup build cache for release
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: release-${{ matrix.arch }}-${{ github.ref_name }}
        max-size: 500M
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r27c
    
    - name: Configure CMake for Release build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.arch }} \
          -DANDROID_PLATFORM=android-21 \
          -DBUILD_TESTING=OFF \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_FLAGS_RELEASE="-O3 -DNDEBUG -flto" \
          -DCMAKE_C_FLAGS_RELEASE="-O3 -DNDEBUG -flto"
    
    - name: Build optimized release
      run: cmake --build build --parallel --config Release
    
    - name: Package system tools
      run: |
        mkdir -p artifacts/${{ matrix.arch }}/bin
        mkdir -p artifacts/${{ matrix.arch }}/docs
        
        # Copy system tool binaries
        cp build/src/logger/logger_daemon artifacts/${{ matrix.arch }}/bin/ 2>/dev/null || echo "logger_daemon not found"
        cp build/src/logger/logger_client artifacts/${{ matrix.arch }}/bin/ 2>/dev/null || echo "logger_client not found"
        cp build/src/filewatcher/filewatcher artifacts/${{ matrix.arch }}/bin/ 2>/dev/null || echo "filewatcher not found"
        
        # Strip debug symbols for smaller binaries
        find artifacts/${{ matrix.arch }}/bin/ -type f -executable -exec strip {} \; 2>/dev/null || true
        
        # Create system tools documentation
        cat > artifacts/${{ matrix.arch }}/README.md << 'EOF'
        # AuroraCore System Tools ${{ github.ref_name }}
        
        ## ç³»ç»Ÿå·¥å…· (System Tools)
        
        æœ¬åŒ…åŒ…å«AuroraCoreçš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶å·¥å…·ï¼Œå¯ç›´æ¥éƒ¨ç½²åˆ°Androidè®¾å¤‡ä½¿ç”¨ã€‚
        
        ### åŒ…å«çš„å·¥å…·
        
        - **logger_daemon** - æ—¥å¿—å®ˆæŠ¤è¿›ç¨‹
        - **logger_client** - æ—¥å¿—å®¢æˆ·ç«¯
        - **filewatcher** - æ–‡ä»¶ç›‘æ§å·¥å…·
        
        ### å¿«é€Ÿä½¿ç”¨
        
        ```bash
        # éƒ¨ç½²åˆ°è®¾å¤‡
        adb push bin/* /data/local/tmp/
        adb shell chmod +x /data/local/tmp/*
        
        # å¯åŠ¨æ—¥å¿—æœåŠ¡
        adb shell /data/local/tmp/logger_daemon -f /data/logs/app.log &
        
        # å‘é€æ—¥å¿—
        adb shell /data/local/tmp/logger_client "Hello AuroraCore!"
        
        # ç›‘æ§æ–‡ä»¶
        adb shell /data/local/tmp/filewatcher /data/config "echo File changed" &
        ```
        
        ### æ–‡æ¡£é“¾æ¥
        
        - [ç³»ç»Ÿå·¥å…·å®Œæ•´æŒ‡å—](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/guide/system-tools.md)
        - [å¼€å‘APIæŒ‡å—](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/guide/development-api.md)
        
        EOF
        
        # Create version info file
        cat > artifacts/${{ matrix.arch }}/VERSION << EOF
        AuroraCore System Tools Release ${{ github.ref_name }}
        Architecture: ${{ matrix.arch }}
        Build Date: $(date -u)
        Commit: ${{ github.sha }}
        
        Components:
        - Logger Daemon: High-performance logging service
        - Logger Client: Command-line logging client
        - File Watcher: Real-time file system monitoring
        
        For development APIs, please visit:
        https://github.com/APMMDEVS/AuroraCore/tree/main/src
        EOF
    
    - name: Upload system tools artifacts
      uses: actions/upload-artifact@v4
      with:
        name: system-tools-${{ matrix.arch }}
        path: artifacts/
        retention-days: 30

  create-system-tools-packages:
    needs: build-system-tools
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all release artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Create system tools packages
      run: |
        mkdir -p release
        
        # Create ARM64 system tools package
        if [ -d "artifacts/system-tools-arm64-v8a" ]; then
          cd artifacts/system-tools-arm64-v8a
          tar -czf ../../release/AuroraCore-SystemTools-${{ github.ref_name }}-arm64-v8a.tar.gz arm64-v8a/
          cd ../..
        fi
        
        # Create x86_64 system tools package
        if [ -d "artifacts/system-tools-x86_64" ]; then
          cd artifacts/system-tools-x86_64
          tar -czf ../../release/AuroraCore-SystemTools-${{ github.ref_name }}-x86_64.tar.gz x86_64/
          cd ../..
        fi
        
        # Create combined package with both architectures
        tar -czf release/AuroraCore-SystemTools-${{ github.ref_name }}-all-architectures.tar.gz \
          -C artifacts/ \
          system-tools-arm64-v8a/arm64-v8a/ \
          system-tools-x86_64/x86_64/ 2>/dev/null || true
        
        # Create API development package (header files only)
        mkdir -p api-package/AuroraCore
        cp -r ../src/loggerAPI api-package/AuroraCore/
        cp -r ../src/filewatcherAPI api-package/AuroraCore/
        cp ../CMakeLists.txt api-package/AuroraCore/
        
        # Create API documentation
        cat > api-package/README.md << 'EOF'
        # AuroraCore Development APIs ${{ github.ref_name }}
        
        ## å¼€å‘API (Development APIs)
        
        æœ¬åŒ…åŒ…å«AuroraCoreçš„C++å¤´æ–‡ä»¶åº“ï¼Œç”¨äºå¼€å‘è‡ªå®šä¹‰åº”ç”¨ç¨‹åºã€‚
        
        ### åŒ…å«çš„API
        
        - **LoggerAPI** (`loggerAPI/logger_api.hpp`) - é«˜æ€§èƒ½æ—¥å¿—è®°å½•åº“
        - **FileWatcherAPI** (`filewatcherAPI/filewatcher_api.hpp`) - æ–‡ä»¶ç³»ç»Ÿç›‘æ§åº“
        
        ### å¿«é€Ÿé›†æˆ
        
        ```cpp
        #include "AuroraCore/loggerAPI/logger_api.hpp"
        #include "AuroraCore/filewatcherAPI/filewatcher_api.hpp"
        
        int main() {
            // ä½¿ç”¨LoggerAPI
            LoggerAPI::InternalLogger::Config config;
            config.log_path = "/data/local/tmp/app.log";
            LoggerAPI::InternalLogger logger(config);
            logger.log(LoggerAPI::LogLevel::INFO, "Hello AuroraCore!");
            
            // ä½¿ç”¨FileWatcherAPI
            FileWatcherAPI::FileWatcher watcher;
            watcher.add_watch("/data/config", [](const auto& event) {
                std::cout << "File changed: " << event.filename << std::endl;
            });
            watcher.start();
            
            return 0;
        }
        ```
        
        ### æ–‡æ¡£é“¾æ¥
        
        - [å¼€å‘APIå®Œæ•´æŒ‡å—](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/guide/development-api.md)
        - [APIå‚è€ƒæ–‡æ¡£](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/api/)
        
        EOF
        
        tar -czf release/AuroraCore-DevelopmentAPI-${{ github.ref_name }}.tar.gz -C api-package .
        
        # Generate checksums
        cd release
        sha256sum *.tar.gz > checksums.sha256
        cd ..
        
        # List created packages
        echo "Created packages:"
        ls -la release/
    
    - name: Upload packages to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.tar.gz
          release/checksums.sha256
        body: |
          ## AuroraCore Release ${{ github.ref_name }}
          
          ### ğŸ”§ ç³»ç»Ÿå·¥å…· (System Tools)
          å³ç”¨å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç›´æ¥éƒ¨ç½²åˆ°Androidè®¾å¤‡ä½¿ç”¨ï¼š
          - `AuroraCore-SystemTools-${{ github.ref_name }}-arm64-v8a.tar.gz` - ARM64 AndroidäºŒè¿›åˆ¶æ–‡ä»¶
          - `AuroraCore-SystemTools-${{ github.ref_name }}-x86_64.tar.gz` - x86_64 AndroidäºŒè¿›åˆ¶æ–‡ä»¶
          - `AuroraCore-SystemTools-${{ github.ref_name }}-all-architectures.tar.gz` - å…¨æ¶æ„åˆå¹¶åŒ…
          
          ### ğŸ› ï¸ å¼€å‘API (Development APIs)
          C++å¤´æ–‡ä»¶åº“ï¼Œç”¨äºå¼€å‘è‡ªå®šä¹‰åº”ç”¨ç¨‹åºï¼š
          - `AuroraCore-DevelopmentAPI-${{ github.ref_name }}.tar.gz` - å¼€å‘APIå¤´æ–‡ä»¶åŒ…
          
          ### ğŸ“‹ åŒ…å«ç»„ä»¶
          
          **ç³»ç»Ÿå·¥å…·ï¼š**
          - `logger_daemon` - é«˜æ€§èƒ½æ—¥å¿—å®ˆæŠ¤è¿›ç¨‹
          - `logger_client` - å‘½ä»¤è¡Œæ—¥å¿—å®¢æˆ·ç«¯
          - `filewatcher` - å®æ—¶æ–‡ä»¶ç³»ç»Ÿç›‘æ§å·¥å…·
          
          **å¼€å‘APIï¼š**
          - `LoggerAPI` - æ—¥å¿—è®°å½•C++åº“
          - `FileWatcherAPI` - æ–‡ä»¶ç›‘æ§C++åº“
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          **ä½¿ç”¨ç³»ç»Ÿå·¥å…·ï¼š**
          ```bash
          # ä¸‹è½½å¹¶éƒ¨ç½²
          wget https://github.com/APMMDEVS/AuroraCore/releases/download/${{ github.ref_name }}/AuroraCore-SystemTools-${{ github.ref_name }}-arm64-v8a.tar.gz
          tar -xzf AuroraCore-SystemTools-${{ github.ref_name }}-arm64-v8a.tar.gz
          adb push arm64-v8a/bin/* /data/local/tmp/
          adb shell chmod +x /data/local/tmp/*
          ```
          
          **ä½¿ç”¨å¼€å‘APIï¼š**
          ```bash
          # ä¸‹è½½APIå¤´æ–‡ä»¶
          wget https://github.com/APMMDEVS/AuroraCore/releases/download/${{ github.ref_name }}/AuroraCore-DevelopmentAPI-${{ github.ref_name }}.tar.gz
          tar -xzf AuroraCore-DevelopmentAPI-${{ github.ref_name }}.tar.gz
          # åœ¨é¡¹ç›®ä¸­åŒ…å«å¤´æ–‡ä»¶
          #include "AuroraCore/loggerAPI/logger_api.hpp"
          ```
          
          ### ğŸ“– æ–‡æ¡£
          - [ç³»ç»Ÿå·¥å…·ä½¿ç”¨æŒ‡å—](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/guide/system-tools.md)
          - [å¼€å‘APIæŒ‡å—](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/guide/development-api.md)
          - [å®Œæ•´æ–‡æ¡£](https://github.com/APMMDEVS/AuroraCore/blob/main/docs/)
          
          ### ğŸ”§ æ„å»ºä¿¡æ¯
          - **æäº¤**: ${{ github.sha }}
          - **æ„å»ºæ—¥æœŸ**: ${{ github.run_started_at }}
          - **Android NDK**: r27c
          - **æœ€ä½Android API**: 21
          
          ### âœ… å®Œæ•´æ€§éªŒè¯
          ```bash
          sha256sum -c checksums.sha256
          ```
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notification job for release completion
  release-notification:
    needs: create-system-tools-packages
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Release status summary
      run: |
        if [[ "${{ needs.create-system-tools-packages.result }}" == "success" ]]; then
          echo "ğŸ‰ AuroraCore ${{ github.ref_name }} ç³»ç»Ÿå·¥å…·å’Œå¼€å‘APIå·²æˆåŠŸæ„å»ºå¹¶å‘å¸ƒï¼"
          echo "ğŸ“¦ ç³»ç»Ÿå·¥å…·: å³ç”¨å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ç›´æ¥éƒ¨ç½²åˆ°Androidè®¾å¤‡"
          echo "ğŸ› ï¸ å¼€å‘API: C++å¤´æ–‡ä»¶åº“ï¼Œç”¨äºå¼€å‘è‡ªå®šä¹‰åº”ç”¨ç¨‹åº"
          echo "ğŸ“– å‘å¸ƒé¡µé¢: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        else
          echo "âŒ Release build failed for ${{ github.ref_name }}"
          exit 1
        fi